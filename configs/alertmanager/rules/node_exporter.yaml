groups:
# General node exporter alerts
- name: node_exporter_alerts
  rules:
  - alert: NodeDown
    expr: up == 0
    for: 2m
    labels:
      severity: warning
    annotations:
      title: Node {{ $labels.instance }} is down
      description: Failed to scrape {{ $labels.job }} on {{ $labels.instance }} for more than 2 minutes. Node seems down.
      details: "Node: {{ $labels.instance }}"
  - alert: HighCPUUsage
    expr: ((sum by(instance) (irate(node_cpu_seconds_total{job="proxmox_nodeexporter", mode!="idle"}[2m])) / on (instance) group_left sum by (instance) (irate(node_cpu_seconds_total{job="proxmox_nodeexporter"}[2m]))) * 100) > 80
    for: 2m
    labels:
      severity: warning
    annotations:
      title: Host high CPU load (instance {{ $labels.instance }})
      description: CPU load is > 80%
      details: "Load: {{ $value }}%"
  - alert: HostHighCpuLoad
    expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[2m])) * 100) > 80
    for: 0m
    labels:
      severity: warning
    annotations:
      title: Host high CPU load (instance {{ $labels.instance }})
      description: CPU load is > 80%
      details: "Load: {{ $value }}%"
  - alert: HostOutOfMemory
    expr: sum by (instance) (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes ) * 100 < 10
    for: 2m
    labels:
      severity: warning
    annotations:
      title: Host out of memory (instance {{ $labels.instance }})
      description: Node memory is filling up (< 10% left)
      details: "Memory: {{ $value }}%"
  - alert: HostMemoryUnderMemoryPressure
    expr: rate(node_vmstat_pgmajfault[1m]) > 1000
    for: 2m
    labels:
      severity: warning
    annotations:
      title: Host memory under memory pressure (instance {{ $labels.instance }})
      description: The node is under heavy memory pressure. High rate of major page faults
      details: "Memory: {{ $value }}"
  - alert: HostUnusalNetworkThroughputIn
    expr: (sum by (instance) (rate(node_network_receive_bytes_total[10m])) / 1024 / 1024) > 50
    for: 10m
    labels:
      severity: warning
    annotations:
      title: Host unusual network throughput in (instance {{ $labels.instance }})
      description: Host network interfaces are probably receiving too much data (> 100 MB/s)\n
      details: "Network: {{ $value }}MB/s"
  - alert: HostUnusualNetworkThroughputOut
    expr: (sum by (instance) (rate(node_network_transmit_bytes_total[10m])) / 1024 / 1024) > 50
    for: 5m
    labels:
      severity: warning
    annotations:
      title: Host unusual network throughput out (instance {{ $labels.instance }})
      description: Host network interfaces are probably sending too much data (> 100 MB/s)\n
      details: "Network: {{ $value }}MB/s"
  - alert: HostUnusualDiskReadLatency
    expr: rate(node_disk_read_time_seconds_total[2m]) / rate(node_disk_reads_completed_total[2m]) > 0.1 and rate(node_disk_reads_completed_total[2m]) > 0
    for: 2m
    labels:
      severity: warning
    annotations:
      title: Host unusual disk read latency (instance {{ $labels.instance }})
      description: Disk latency is growing (read operations > 100ms)\n
      details: "Disk: {{ $value }}ms"
  - alert: HostUnusualDiskWriteLatency
    expr: rate(node_disk_write_time_seconds_totali{device!~"mmcblk.+"}[1m]) / rate(node_disk_writes_completed_total{device!~"mmcblk.+"}[1m]) > 0.1 and rate(node_disk_writes_completed_total{device!~"mmcblk.+"}[1m]) > 0
    for: 2m
    labels:
      severity: warning
    annotations:
      title: Host unusual disk write latency (instance {{ $labels.instance }})
      description: Disk latency is growing (write operations > 100ms)\n
      details: "Disk: {{ $value }}ms"
  - alert: HostOomKillDetected
    expr: increase(node_vmstat_oom_kill[1m]) > 0
    for: 0m
    labels:
      severity: warning
    annotations:
      title: Host OOM kill detected (instance {{ $labels.instance }})
      description: OOM kill detected\n
      details: "OOM kill: {{ $value }}"
  - alert: HostNetworkReceiveErrors
    expr: rate(node_network_receive_errs_total[2m]) / rate(node_network_receive_packets_total[2m]) > 0.01
    for: 2m
    labels:
      severity: warning
    annotations:
      title: Host Network Receive Errors (instance {{ $labels.instance }}:{{ $labels.device }})
      description: Instance interface has encountered {{ printf "%.0f" $value }} receive errors in the last five minutes.\n
      details: "Network: {{ $value }}"
  - alert: HostNetworkTransmitErrors
    expr: rate(node_network_transmit_errs_total[2m]) / rate(node_network_transmit_packets_total[2m]) > 0.01
    for: 2m
    labels:
      severity: warning
    annotations:
      title: Host Network Transmit Errors (instance {{ $labels.instance }}:{{ $labels.device }})
      description: Instance has encountered {{ printf "%.0f" $value }} transmit errors in the last five minutes.\n
      details: "Network: {{ $value }}"
  - alert: HostClockSkew
    expr: (node_timex_offset_seconds > 0.05 and deriv(node_timex_offset_seconds[5m]) >= 0) or (node_timex_offset_seconds < -0.05 and deriv(node_timex_offset_seconds[5m]) <= 0)
    for: 2m
    labels:
      severity: warning
    annotations:
      title: Host clock skew (instance {{ $labels.instance }})
      description: Clock skew detected. Clock is out of sync.\n
      details: "Clock: {{ $value }}s"
  - alert: HostClockNotSynchronising
    expr: min_over_time(node_timex_sync_status[1m]) == 0 and node_timex_maxerror_seconds >= 16
    for: 2m
    labels:
      severity: warning
    annotations:
      title: Host clock not synchronising (instance {{ $labels.instance }})
      description: Clock not synchronising.\n
      details: "Clock: {{ $value }}s"

# Node exporter temperature alerts
- name: temperature_alerts
  rules:
  - alert: TemperatureHighCPUTemp
    expr: |
      avg by (instance) (
        node_hwmon_temp_celsius{job="proxmox_nodeexporter"}
        * on(instance, chip) group_left(chip_name)
        node_hwmon_chip_names{job="proxmox_nodeexporter"}
      ) > 70
    for: 2m
    labels:
      severity: warning
    annotations:
      title: "High CPU Temperature: {{ $labels.instance }}."
      description: "High CPU temp detected on node {{ $labels.instance }}. \n  Temp = {{ $value }}°C"
  - alert: TemperatureCriticalCPUTemp
    expr: |
      avg by (instance) (
        node_hwmon_temp_celsius{job="proxmox_nodeexporter"}
        * on(instance, chip) group_left(chip_name)
        node_hwmon_chip_names{job="proxmox_nodeexporter"}
      ) > 80
    for: 2m
    labels:
      severity: critical
    annotations:
      title: "Critical CPU Temperature: {{ $labels.instance }}."
      description: Critical CPU temp detected on node {{ $labels.instance }}. Consider shutting down.
      details: "Temp: {{ $value }}°C"
  - alert: TemperatureHighDiskTemp
    expr: avg(smartctl_device_temperature * on(instance, device) group_left(interface,serial_number,model_name) smartctl_device) by (instance,device,model_name) > 70
    for: 2m
    labels:
      severity: warning
    annotations:
      title: "{{ $labels.model_name }}: High Disk Temperature ({{ $labels.instance }} / {{ $labels.device }})."
      description: "High disk temp detected on node {{ $labels.instance }}. \n Disk: {{ $labels.device }} \n Model: {{ $labels.model_name }}"
      details: "Temp: {{ $value }}°C"